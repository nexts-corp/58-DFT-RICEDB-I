{{>header}}
<style>
    .row-tr,.pointer :hover{
        cursor: pointer;
    }
</style>
<div role="main" class="main">
    <section class="page-top none-margin">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <ul class="breadcrumb">
                        <li><a href="#">{{#i18n}}auction.home{{/i18n}}</a></li>
                        <li class="active">{{#i18n}}auction.menu{{/i18n}}</li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h1 class="none-padding">{{#i18n}}auction.return.title{{/i18n}}</h1>
                </div>
            </div>
        </div>
    </section>

    <hr class="tall dashboard">
    <div class="sort-source-wrapper">
        <div class="container">
            <ul class="nav nav-pills sort-source menu-top pull-right" data-sort-id="portfolio" data-option-key="filter">
                <li data-option-value=".websites" class="padding-left">
                    <button id="showTable" class="btn btn-primary table" style="display: none;"><i class="fa fa-list"></i> {{#i18n}}auction.buttonInfoList{{/i18n}}</button>
                </li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class='col-md-12'>
                <div id="bidderTable" class="col-md-12" style="margin-top: 10px;">
                    <section class="panel form-wizard" id="w1"><!-- search -->
                        <div class="panel-body panel-body-nopadding">
                            <div class="col-md-12" style="margin: 20px 0px 20px 0px;">
                                <div class="col-xs-4">
                                    <label class="col-md-4 control-label text-right" for="searchQueue">{{#i18n}}auction.queue{{/i18n}} :</label>
                                    <div class="col-md-8">
                                        <select class="form-control input-sm" name="searchQueue" id="searchQueue" required>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section><!-- end search -->

                    <div class="table-responsive col-md-12">
                        <table id="table" class="table table-bordered table-striped table-condensed mb-none">
                            <thead>
                                <tr>
                                    <th class="text-center col-md-2">{{#i18n}}auction.queue{{/i18n}}</th>
                                    <th class="text-center col-md-7">{{#i18n}}auction.bidder{{/i18n}}</th>
                                    <th class="text-center col-md-3">{{#i18n}}auction.action{{/i18n}}</th>
                                </tr>
                            </thead>
                            <tbody id="bidderBody">
                                <tr>
                                    <td colspan="3" class="text-center">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div><!-- col-md-12 -->

                <div id="paymentTable" class="col-md-12" style="display:none;margin-top: 10px;">
                    <div class="col-md-10">
                        <div class="col-md-12 table-responsive">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h2 class="panel-title">{{#i18n}}auction.return.panelInfo{{/i18n}}</h2>
                                    <div style="float: right; margin-top: -25px;">
                                        <button class="btn btn-primary checkList"><i class="fa fa-print"></i> {{#i18n}}auction.buttonReturn{{/i18n}}</button>
                                    </div>
                                </div>
                                <div class="panel-body">
                                    <table class="table table-bordered table-striped table-condensed mb-none">
                                        <thead>
                                            <tr>
                                                <th class="text-center col-md-2">{{#i18n}}auction.queue{{/i18n}}</th>
                                                <th class="text-center col-md-8">{{#i18n}}auction.bidder{{/i18n}}</th>
                                                <th class="text-center col-md-2">{{#i18n}}auction.mobile{{/i18n}}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="bdBody">
                                            <tr>
                                                <td colspan="3" class="text-center">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 table-responsive">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <div class="panel-actions">
                                        <a href="#" class="fa fa-caret-up"></a>
                                    </div>
                                    <h2 class="panel-title">{{#i18n}}auction.return.panelWinner{{/i18n}}</h2>
                                </div>
                                <div class="panel-body">
                                    <table class="table table-bordered table-striped table-condensed mb-none">
                                        <thead>
                                            <tr>
                                                <th class="text-center">{{#i18n}}auction.no{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}auction.province{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}auction.associate{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}auction.silo{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}auction.weightAll{{/i18n}} ({{#i18n}}auction.ton{{/i18n}})</th>
                                                <th class="text-center">{{#i18n}}auction.priceLast{{/i18n}} ({{#i18n}}auction.bath{{/i18n}})</th>
                                                <th class="text-center">{{#i18n}}auction.countPayment{{/i18n}} 2%</th>
                                            </tr>
                                        </thead>
                                        <tbody id="whBody">
                                            <tr>
                                                <td colspan="7" class="text-center">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12 table-responsive">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <div class="panel-actions">
                                        <a href="#" class="fa fa-caret-up"></a>
                                    </div>
                                    <h2 class="panel-title">{{#i18n}}auction.return.panelPayment{{/i18n}}</h2>
                                </div>
                                <div class="panel-body">
                                    <div class="col-md-12">
                                        <div class='col-md-6'>
                                            <p>{{#i18n}}auction.choose{{/i18n}} <span id='countCheckbox'>0</span>/<span id='countAll'>0</span></p>
                                        </div>
                                        <div class="col-md-6 text-right pointer">
                                            <input type="checkbox" name="all" id="checkall" /> <label for="checkall">{{#i18n}}auction.chooseAll{{/i18n}}</label>
                                        </div>
                                    </div>
                                    <table id="pTable" class="table table-bordered table-striped table-condensed mb-none">
                                        <thead>
                                            <tr>
                                                <th class="text-center">{{#i18n}}auction.no{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}auction.typePayment{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}auction.bank{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}auction.bankDate{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}auction.bankNo{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}auction.bankAmount{{/i18n}} ({{#i18n}}auction.bath{{/i18n}})</th>
                                                <th class="text-center">{{#i18n}}auction.remark{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}auction.action{{/i18n}}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="paymentBody">
                                            <tr>
                                                <td colspan="8" class="text-center">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <div class="col-md-12">
                            <nav id="affix-nav" class="sidebar">
                                <div class="nav sidenav" data-spy="affix" data-offset-top="0" style="font-size: 130%; min-width: 220px; border: 2px solid #aaa; padding: 9px;">                                    
                                    <div class="text-danger">{{#i18n}}auction.canReturn{{/i18n}}</div>
                                    <div class="text-danger text-right text-bold"><span id="txtReturn">0</span> {{#i18n}}auction.bath{{/i18n}}</div><br>

                                    <div class="text-success">{{#i18n}}auction.wouldReturn{{/i18n}}</div>
                                    <div class="text-success text-right text-bold"><span id="txtSelect">0</span> {{#i18n}}auction.bath{{/i18n}}</div><br>

                                    <div class="text-warning">{{#i18n}}auction.balance{{/i18n}}</div>
                                    <div class="text-warning text-right text-bold"><span id="txtBalance">0</span> {{#i18n}}auction.bath{{/i18n}}</div>

                                </div>
                            </nav>
                        </div>
                    </div>
                    <div class="col-md-12 text-center">
                        <button id="btnSave" class="btn btn-primary"><i class="fa fa-save"></i> {{#i18n}}auction.buttonSave{{/i18n}}</button>
                    </div>
                </div><!-- col-md-12 -->
            </div><!-- col-md-9 -->
        </div><!--  row  -->
    </div><!--  container  -->
</div><!-- main -->
{{>footer}}
<script type="text/javascript">
    var listArr = [];

    var sumGuarantee = 0;
    var sumPayment = 0;
    var sumReturn = 0;
    var sumBalance = 0;
    var countCheck = 0;
    var dataPayment;

    $(function () {
        listBidder();

        $("#searchQueue").select2();

        $("button.table").click(function () {
            toggleShow("list");
        });

        $("#btnSave").click(function () {
            var data = checkSelect();
            if (data == "noCheckbox") {
                $.alert({
                    title: 'คำแนะนำ!',
                    content: 'ไม่ได้เลือกหลักค้ำประกัน!',
                    confirmButton: "ตกลง",
                    theme: 'black',
                    columnClass: 'col-md-4 col-md-offset-4'
                });
            } else {
                var cfm = $.confirm({
                    title: 'ยืนยันการอนุมัติ!',
                    content: "คุณต้องการที่จะทำต่อ?",
                    confirmButton: 'ตกลง',
                    cancelButton: 'ยกเลิก',
                    confirmButtonClass: 'btn-success',
                    cancelButtonClass: 'btn-warning',
                    theme: 'holodark',
                    columnClass: 'col-md-4 col-md-offset-4',
                    autoClose: 'cancel|11000',
                    confirm: function () {
                        $("#bidderBody").html("<tr><td colspan='3' class='text-center'>กำลังโหลดข้อมูล</td></tr>");
                        cfm.close();
                        setTimeout(function () {
                            var jData = {};
                            jData["bidderPayment"] = checkSelect();
                            var dataJSON = JSON.stringify(jData);
                            var dataJSONEN = encodeURIComponent(dataJSON);
                            var msg = callAjax("{{_context_path}}/api/industry2/return/update", "post", dataJSONEN, "json");
                            if (msg.update === true) {
                                alert("บันทึกเรียบร้อย");
                                listBidder();
                                $(".checkList").focus();
                                //swap();
                                //listPayment();
                            } else {
                                alert("ERROR!!");
                            }
                        }, 1000);

                    }
                });

            }
        });
    });

    function listBidder() {
        var dataSet = [];
        var searchQueue = {};
        var datas = callAjax("{{_context_path}}/api/industry2/return/listsBidder", "post", {}, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            $.each(datas["lists"], function (key, value) {
                listArr[value["bidderHistoryId"]] = value;
                dataSet.push(value);

                searchQueue[value["queue"]] = value["queue"];
            });

            $("#searchQueue").empty();
            $("#searchQueue").append('<option value="" selected="selected">ทั้งหมด</option>');
            $.each(searchQueue, function (key, value) {
                $("#searchQueue").append('<option value="' + value + '">' + value + '</option>');
            });
        }

        var t = $("#table").DataTable({
            "destroy": true,
            "data": dataSet,
            "order": [[0, 'asc']],
            "iDisplayLength": 50,
            "columnDefs": [
                {
                    "targets": 0,
                    "data": "queue",
                    "sClass": "text-center col-md-2"
                },
                {
                    "targets": 1,
                    "data": "bidderName",
                    "sClass": "text-left col-md-8"
                },
                {
                    "targets": 2,
                    "orderable": false,
                    "data": "bidderHistoryId",
                    "sClass": "text-center col-md-2",
                    "render": function (data) {
                        var content = '<button class="btn btn-primary return" data-hid="' + data + '"><i class="fa fa-pencil"></i> คืน</button>';
                        return content;
                    }
                }
            ]
        });

        $('#searchQueue').change(function () {
            if ($('#searchQueue').val() != "") {
                t.columns(0).search("^" + $(this).val() + "$", true, false, true).draw();
            }
            else {
                t.columns(0).search($(this).val()).draw();
            }
        });

        $("#table").off("click", "button.return").on("click", "button.return", function () {
            toggleShow("payment");

            var historyId = $(this).attr("data-hid");
            bindBidder(historyId);
            listWarehouse(historyId);
            listPayment(historyId);
        });
    }

    function bindBidder(hId) {
        var value = listArr[hId];

        var html = '';
        html += '<tr>'
                + '<td class="text-center">' + value["queue"] + '</td>'
                + '<td class="text-center">' + value["bidderName"] + '</td>'
                + '<td class="text-center">' + value["mobile"] + '</td>'
                + '</tr>';

        $("#bdBody").html(html);

        $("button.checkList").unbind().click(function () {
            var dataHistory = {};
            dataHistory["queue"] = value["queue"];
			dataHistory["type"]="industry2";

            var fdata = {};
            fdata["report"] = dataHistory;
            var dataJSON = JSON.stringify({report: fdata["report"]});
            var dataJSONEN = encodeURIComponent(dataJSON);

            var datas = callAjax("{{_context_path}}/api/report/report/returnPayment", "post", dataJSONEN, "json");
            if (typeof datas !== 'undefined' && datas !== null) {
                var win = window.open(datas["export"], '_blank');
                win.focus();
            }
        });
    }

    function listWarehouse(hId) {
        var datas = callAjax("{{_context_path}}/api/industry2/return/listsWarehouse", "post", {bidderId: listArr[hId]["bidderId"]}, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            var html = "";
            var sumBidderPrice = 0;
            var sumWeight = 0;
            sumGuarantee = 0;

            $.each(datas["lists"], function (key, value) {
                html += '<tr>'
                        + '<td class="text-center">' + (key + 1) + '</td>'
                        + '<td class="text-center">' + value["province"] + '</td>'
                        + '<td class="text-center">' + value["associate"] + '</td>'
                        + '<td class="text-center">' + value["wareHouseCode"] + '</td>'
                        + '<td class="text-center text-tertiary">' + accounting.formatNumber(value["oweightAll"], 6, ",", ".") + '</td>'
                        + '<td class="text-center">' + accounting.formatNumber(value["bidderFirstPrice"], 2, ",", ".") + '</td>'
                        + '<td class="text-center text-bold">' + accounting.formatNumber(value["guarantee"], 2, ",", ".") + '</td>'
                        + '</tr>';

                sumBidderPrice += parseFloat(value.bidderFirstPrice);
                sumWeight += parseFloat(value.weightAll);
                sumGuarantee += parseFloat(value.guarantee);
            });

            html += '<tr>'
                    + '<td colspan="4" class="text-center">รวมจำนวนหลักค้ำประกัน</td>'
                    + '<td class="text-center text-bold text-tertiary">' + accounting.formatNumber(sumWeight, 6, ",", ".") + '</td>'
                    + '<td class="text-center text-bold">' + accounting.formatNumber(sumBidderPrice, 2, ",", ".") + '</td>'
                    + '<td class="text-center text-bold">' + accounting.formatNumber(sumGuarantee, 2, ",", ".") + '</td>'
                    + '</tr>';

            $("#whBody").html(html);
        }
    }

    function listPayment(hId) {
        var datas = callAjax("{{_context_path}}/api/industry2/return/listsPayment", "post", {bidderHistoryId: hId}, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            var html = "";
            sumPayment = 0;
            var sumReturn = 0;
            dataPayment = datas["lists"];
            $.each(datas["lists"], function (key, value) {
                if (value.remark == null || value.remark == "") {
                    value.remark = "-";
                }

                var check = "";
                if (value.isReturn == "Y") {
                    check = "checked";
                    sumReturn += value.amount;
                    countCheck++;
                }

                html += '<tr row-index="' + key + '" class="row-tr">'
                        + '<td class="text-center">' + (key + 1) + '</td>'
                        + '<td class="text-center">' + (value.payment) + '</td>'
                        + '<td class="text-center">' + (value.bankTH) + '</td>'
                        + '<td class="text-center">' + (value.paymentDate["date"].substr(0, 10)) + '</td>'
                        + '<td class="text-center">' + (value.paymentNo) + '</td>'
                        + '<td class="text-center">' + accounting.formatNumber(value.amount, 2, ",", ".") + '</td>'
                        + '<td class="text-center">' + (value.remark) + '</td>'
                        + '<td class="text-center text-bold">'
                        + '<label class="switch switch-green">'
                        + '<input class="switch-input" type="checkbox" onclick="return false" value="' + value.amount + '" ' + check + '>'
                        + '<span class="switch-label" data-on="คืน" data-off="ไม่คืน"></span>'
                        + '<span class="switch-handle"></span>'
                        + '</label>'
                        + '</td>'
                        + '</tr>';

                sumPayment += parseFloat(value.amount);
                $("#countAll").text((key + 1));
            });
            html += '<tr>'
                    + '<td colspan="5" class="text-center">รวมจำนวนหลักค้ำประกัน</td>'
                    + '<td class="text-center text-bold">' + accounting.formatNumber(sumPayment, 2, ",", ".") + '</td>'
                    + '<td colspan="2"></td>'
                    + '</tr>';

            $("#paymentBody").html(html);

            $("#txtReturn").text(accounting.formatNumber(sumPayment - sumGuarantee, 2, ",", "."));
            $("#txtSelect").text(accounting.formatNumber(sumReturn, 2, ",", "."));
            $("#txtBalance").text(accounting.formatNumber(sumPayment - sumReturn, 2, ",", "."));

            //when you change check box
            $("#countCheckbox").text(countCheck);

            $("input.switch-input").click(function (event) {
                event.stopPropagation();
            });

            $(".row-tr").unbind().click(function (event) {
                var input = $(this).find("td label input.switch-input");

                if (!input.is(":checked"))
                    input.prop("checked", true);
                else
                    input.prop("checked", false);
                //input.trigger("click");

                if (input.is(":checked")) {
                    console.log("1");
                    countCheck++;
                    sumReturn += parseFloat(input.val());

                }
                else {
                    console.log("2");
                    countCheck--;
                    sumReturn -= parseFloat(input.val());
                }

                if (parseInt(sumPayment - sumReturn) < parseInt(sumGuarantee)) {
                    //$(this).removeAttr("checked");
                    //event.stopImmediatePropagation();
                    alert("จำนวนหลักค้ำประกันไม่พอ");

                    countCheck--;
                    sumReturn -= parseFloat(input.val());

                    input.prop("checked", false);
                    $("#checkall").prop("checked", false);

                }

                $("#countCheckbox").html(countCheck);
                $("#txtSelect").text(accounting.formatNumber(sumReturn, 2, ",", "."));
                $("#txtBalance").text(accounting.formatNumber(sumPayment - sumReturn, 2, ",", "."));

            });

            $("#checkall").prop("checked", false);
            $("#checkall").unbind().click(function () {
                if ($("#checkall").is(":checked")) {
                    $(".row-tr").each(function () {
                        $(this).trigger("click");
                    });
                }
                else {
                    $(".row-tr").each(function () {
                        $(this).trigger("click");
                    });
                }
            });
            /*$("input.switch-input").unbind("click").click(function(){
             if($(this).is(":checked")){
             console.log("1");
             countCheck++;
             sumReturn += parseFloat($(this).val());
              
             //$(this).prop("checked", true);
             }
             else{
             console.log("2");
             countCheck--;
             sumReturn -= parseFloat($(this).val());
             }
              
             if (parseInt(sumPayment - sumReturn) < parseInt(sumGuarantee)) {  
             //$(this).removeAttr("checked");
             //event.stopImmediatePropagation();
             alert("จำนวนหลักค้ำประกันไม่พอ");
              
             countCheck--;
             sumReturn -= parseFloat($(this).val());
              
             $(this).prop("checked", false);
             $("#checkall").prop("checked", false);
              
             }
              
             $("#countCheckbox").html(countCheck);
             $("#txtSelect").text(accounting.formatNumber(sumReturn, 2, ",", "."));
             $("#txtBalance").text(accounting.formatNumber(sumPayment - sumReturn, 2, ",", "."));
             });
              
             $("#checkall").prop("checked", false); 
             $("#checkall").unbind().click(function(){
             if ($("#checkall").is(":checked")) {
             $("input.switch-input").each(function () {
             if(!$(this).is(":checked")){
             $(this).trigger("click");
             }
             });
             } 
             else {
             console.log("2");
             $("input.switch-input").each(function () {
             if($(this).is(":checked")){
             $(this).trigger("click");
             }
             });
             }
             });
              
             $(".row-tr").unbind().click(function (event) {
             //event.stopPropagation();
              
             //var input = $(this).find("td label input.switch-input");
             //input.trigger("click");
             if (event.target.type !== 'checkbox') {
             $(':checkbox', this).trigger('click');
             }
             });*/
        }
    }

    function checkSelect() {
        var i = 0;
        var dataApprove = [];
        $('input.switch-input').each(function () {
            if ($(this).is(":checked")) {
                dataPayment[$(this).closest("tr").attr("row-index")]["isReturn"] = "Y";
                dataPayment[$(this).closest("tr").attr("row-index")]["dateReturn"] = "date";
            } else {
                dataPayment[$(this).closest("tr").attr("row-index")]["isReturn"] = "N";
                //dataPayment[$(this).closest("tr").attr("row-index")]["dateReturn"] = "-";
            }
            dataApprove[i++] = dataPayment[$(this).closest("tr").attr("row-index")];
        });

        if (dataApprove[0] == null) {
            return "noCheckbox";
        } else {
            return dataApprove;
        }

    }

    function toggleShow(option) {
        if (option == "payment") {
            $("#paymentTable, #showTable").show();
            $("#bidderTable").hide();
        }
        else if (option == "list") {
            $("#paymentTable, #showTable").hide();
            $("#bidderTable").show();
            listBidder();
        }
    }
</script>
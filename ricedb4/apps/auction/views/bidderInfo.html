{{>header}}
<div role="main" class="main">
    <section class="page-top none-margin">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <ul class="breadcrumb">
                        <li><a href="#">หน้าหลัก</a></li>
                        <li class="active">ระบบประมูล</li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h1 class="none-padding">ข้อมูลผู้เสนอซื้อ</h1>
                </div>
            </div>
        </div>
    </section>

    <hr class="tall dashboard">

    <div class="sort-source-wrapper"><!-- button action on header -->
        <div class="container">
            <ul class="nav nav-pills sort-source menu-top pull-right" data-sort-id="portfolio" data-option-key="filter">
                <li class="active">
                    <button id="addToTable" class="btn btn-primary add"><i class="fa fa-plus"></i>&nbsp;เพิ่มข้อมูล</button>
                    <button id="showTable" class="btn btn-primary table" style="display: none;">รายชื่อผู้เสนอซื้อ</button>
                </li>
            </ul>
        </div>
    </div><!-- end button action on header -->

    <div class="container">
        <div class="row">
            <div id="bidderTable"><!-- table shown bidder information list -->
                <section class="panel form-wizard" id="w1"><!-- search -->
                    <div class="panel-body panel-body-nopadding">
                        <div class="col-md-12" style="margin: 20px 0px 20px 0px;">
                            <div class="col-xs-4">
                                <label class="col-md-4 control-label" for="searchQueue">คิวที่</label>
                                <div class="col-md-8">
                                    <select class="form-control input-sm" name="searchQueue" id="searchQueue" required>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </section><!-- end search -->
                
                <div class="col-md-12">
                    <table id="table" class="table table-bordered table-striped table-condensed mb-none">
                        <thead>
                            <tr>
                                <th class="text-center col-md-1" rowspan="2" style="vertical-align: middle;">ลำดับ</th>
                                <th class="text-center col-md-1" rowspan="2" style="vertical-align: middle;">คิวที่</th>
                                <th class="text-center col-md-1" rowspan="2" style="vertical-align: middle;">เวลาที่ยื่น</th>
                                <th class="text-center col-md-2" rowspan="2" style="vertical-align: middle;">ผู้เสนอซื้อ</th>
                                <th class="text-center col-md-4" colspan="5">ตรวจสอบคุณสมบัติ</th>
                                <th class="text-center col-md-1" rowspan="2" style="vertical-align: middle;">ยื่นซองเสนอซื้อ</th>
                                <th class="text-center col-md-1" rowspan="2" style="vertical-align: middle;">แก้ไข / ลบ</th>
                                <!--<th class="text-center">ลบ</th>-->
                            </tr>
                            <tr>
                                <th class="text-center" style="vertical-align: middle;">เอกสารเสนอซื้อ</th>
                                <th class="text-center" style="vertical-align: middle;">ตรวจสอบ ไม่เป็น ผู้ละทิ้งงาน</th>
                                <th class="text-center" style="vertical-align: middle;">ตรวจสอบไม่เป็นผู้ละทิ้ง<br>การเสนอซื้อ/สัญญาซื้อขาย</th>
                                <th class="text-center" style="vertical-align: middle;">กรมการค้าภายใน</th>
                                <th class="text-center" style="vertical-align: middle;">กรมพัฒนาธุรกิจการค้า</th>
                            </tr>
                        </thead>
                        <tbody id="bidderBody">
                            <tr>
                                <td colspan="11" class="text-center">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div><!-- end table shown bidder information list -->

            <div id="bidderForm" class="col-md-12" style="display: none;"><!-- bidder info form -->
                <form id="form" class="form-horizontal form-bordered form-validation" onsubmit="return(false)">
                    <div class="col-xs-12">
                        <section class="panel">
                            <header class="panel-heading">
                                <div class="panel-actions">
                                    <a href="#" class="fa fa-caret-up"></a>
                                </div>
                                <h2 class="panel-title">ข้อมูลผู้เสนอซื้อ</h2>
                            </header>

                            <div class="panel-body">
                                <div class="form-group">
                                    <label class="col-md-3 control-label req" for="queue">คิวที่</label>
                                    <div class="col-md-2">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <i class="fa fa-plus"></i>
                                            </span>
                                            <input type="text" data-entity="history" class="form-control input-sm" name="queue" id="queue" required>
                                        </div>
                                    </div>

                                    <label class="col-md-2 control-label req" for="dateRegister">เวลาที่ยื่น (08:30 หรือ 08.30)</label>
                                    <div class="col-md-2">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <i class="fa fa-clock-o"></i>
                                            </span>
                                            <input type="text"  data-entity="history" class="form-control input-sm" name="dateRegister" id="dateRegister" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label req" for="taxId">เลขผู้เสียภาษี</label>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <i class="fa fa-tag"></i>
                                            </span>
                                            <input type="text" data-entity="info" class="form-control input-sm number" name="taxId" id="taxId" required>
                                        </div>
                                    </div>
                                    <div id="searching"></div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label req" for="bidderName">ชื่อผู้เสนอซื้อ</label>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <i class="fa fa-user"></i>
                                            </span>
                                            <input type="text" data-entity="info" class="form-control input-sm" name="bidderName" id="bidderName" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label req" for="agentName">ชื่อผู้ยื่น</label>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <i class="fa fa-user"></i>
                                            </span>
                                            <input type="text" data-entity="history" class="form-control input-sm" name="agentName" id="agentName" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label" for="agentName">ชื่อผู้ยื่นซอง</label>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <i class="fa fa-user"></i>
                                            </span>
                                            <input type="text" data-entity="history" class="form-control input-sm" name="agentName2" id="agentName2">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label req" for="mobile">เบอร์โทรศัพท์ (มือถือ)</label>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <i class="fa fa-phone"></i>
                                            </span>
                                            <input type="text" data-entity="history" class="form-control input-sm" name="mobile" id="mobile" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label" for="fax">เบอร์โทรสาร (Fax)</label>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <i class="fa fa-fax"></i>
                                            </span>
                                            <input type="text" data-entity="info" class="form-control input-sm" name="fax" id="fax">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label" for="email">อีเมล์</label>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-addon">
                                                <i class="fa fa-envelope"></i>
                                            </span>
                                            <input type="text" data-entity="info" class="form-control input-sm" name="email" id="email">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label" for="typeBiz">ประเภท</label>
                                    <div class="col-md-6">
                                        <div class="radio">
                                            <label>
                                                <input type="radio" data-entity="info" name="typeBiz" id="typeBiz1" value="1" checked>
                                                นิติบุคคล
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input type="radio" data-entity="info" name="typeBiz" id="typeBiz2" value="2">
                                                รัฐวิสาหกิจ
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input type="radio" data-entity="info" name="typeBiz" id="typeBiz3" value="3">
                                                สหกรณ์
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input type="radio" data-entity="info" name="typeBiz" id="typeBiz4" value="4">
                                                บุคคลธรรมดา
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div><!-- col-xs-12 -->

                    <div class="col-xs-12">
                        <section class="panel">

                            <header class="panel-heading">
                                <div class="panel-actions">
                                    <a href="#" class="fa fa-caret-up"></a>
                                </div>
                                <h2 class="panel-title">ตรวจสอบคุณสมบัติ</h2>
                            </header>

                            <div class="panel-body">
                                <div class="form-group">
                                    <label class="col-md-3 control-label" for="property">เอกสารการเสนอซื้อ</label>
                                    <div class="col-md-6">
                                        <div class="radio">
                                            <label>
                                                <input class="remarkControl"  type="radio" data-entity="history" name="property1" id="property1_1" value="Y" checked>
                                                <i class="fa fa-check text-success"></i> ครบ
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input class="remarkControl" type="radio" data-entity="history" name="property1" id="property1_2" value="N">
                                                <i class="fa fa-times text-danger"></i> ไม่ครบ
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-12" style="margin-left: -8px; margin-top: 10px;">
                                        <label id="remarkLabel1" class="col-md-3 control-label" for="remark1">หมายเหตุ</label>
                                        <div class="col-md-6">
                                            <input type="text" data-entity="history" class="form-control input-sm" name="remark1" id="remark1">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label" for="property2">ตรวจสอบไม่เป็นผู้ละทิ้งงาน<br>ของกรมบัญชีกลาง</label>
                                    <div class="col-md-6">
                                        <div class="radio">
                                            <label>
                                                <input class="remarkControl" type="radio" data-entity="history" name="property2" id="property2_1" value="Y" checked>
                                                <i class="fa fa-check text-success"></i> ผ่าน
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input class="remarkControl" type="radio" data-entity="history" name="property2" id="property2_2" value="N">
                                                <i class="fa fa-times text-danger"></i> ไม่ผ่าน
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-12" style="margin-left: -8px; margin-top: 10px;">
                                        <label id="remarkLabel2" class="col-md-3 control-label" for="remark2">หมายเหตุ</label>
                                        <div class="col-md-6">
                                            <input type="text" data-entity="history" class="form-control input-sm" name="remark2" id="remark2">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label" for="property3">ตรวจสอบผู้ละทิ้งการเสนอซื้อและหรือ<br>ละทิ้งสัญญาซื้อ-ขายข้าวทางราชการ</label>
                                    <div class="col-md-6">
                                        <div class="radio">
                                            <label>
                                                <input class="remarkControl" type="radio" data-entity="history" name="property3" id="property3_1" value="Y" checked>
                                                <i class="fa fa-check text-success"></i> ผ่าน
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input class="remarkControl" type="radio" data-entity="history" name="property3" id="property3_2" value="N">
                                                <i class="fa fa-times text-danger"></i> ไม่ผ่าน
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-12" style="margin-left: -8px; margin-top: 10px;">
                                        <label id="remarkLabel3" class="col-md-3 control-label" for="remark3">หมายเหตุ</label>
                                        <div class="col-md-6">
                                            <input type="text" data-entity="history" class="form-control input-sm" name="remark3" id="remark3">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label" for="property4">ตรวจสอบหนังสืออนุญาตให้ประกอบการค้า<br>ข้าวของกรมการค้าภายใน ณ ปัจจุบัน</label>
                                    <div class="col-md-6">
                                        <div class="radio">
                                            <label>
                                                <input class="remarkControl" type="radio" data-entity="history" name="property4" id="property4_1" value="Y" checked>
                                                <i class="fa fa-check text-success"></i> ผ่าน
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input class="remarkControl" type="radio" data-entity="history" name="property4" id="property4_2" value="N">
                                                <i class="fa fa-times text-danger"></i> ไม่ผ่าน
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-12" style="margin-left: -8px; margin-top: 10px;">
                                        <label id="remarkLabel4" class="col-md-3 control-label" for="remark4">หมายเหตุ</label>
                                        <div class="col-md-6">
                                            <input type="text" data-entity="history" class="form-control input-sm" name="remark4" id="remark4">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label" for="property5">ตรวจสอบบัญชีรายชื่อผู้ถือหุ้น<br>ที่ได้รับรองจากกรมพัฒนาธุรกิจการค้า</label>
                                    <div class="col-md-6">
                                        <div class="radio">
                                            <label>
                                                <input class="remarkControl" type="radio" data-entity="history" name="property5" id="property5_1" value="Y" checked>
                                                <i class="fa fa-check text-success"></i> ผ่าน
                                            </label>
                                        </div>
                                        <div class="radio">
                                            <label>
                                                <input class="remarkControl" type="radio" data-entity="history" name="property5" id="property5_2" value="N">
                                                <i class="fa fa-times text-danger"></i> ไม่ผ่าน
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-12" style="margin-left: -8px; margin-top: 10px;">
                                        <label id="remarkLabel5" class="col-md-3 control-label" for="remark5">หมายเหตุ</label>
                                        <div class="col-md-6">
                                            <input type="text" data-entity="history" class="form-control input-sm" name="remark5" id="remark5">
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </section>
                    </div><!-- col-xs-12 -->

                    <div id="loading" class="col-xs-12" style="text-align: center;"></div>
                    <ul class="nav nav-pills sort-source secundary pull-right" data-sort-id="portfolio" data-option-key="filter">
                        <li data-option-value="*" class="">
                            <button id="submit" class="btn btn-primary submit">บันทึก</button>
                        </li>
                        <li data-option-value=".websites" class="padding-left">
                            <button type="button" class="btn btn-default cancel">ยกเลิก</button>
                        </li>
                    </ul>

                </form>
            </div><!-- end bidder info form -->

            <div id="bidderModal" aria-labelledby="bidderLabel" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"><!-- delete bidder info form -->
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">ลบข้อมูล : ผู้เสนอซื้อ</h4>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped table-condensed mb-none">
                                    <tbody>
                                    <tr>
                                        <td>คิวที่</td><td class="text-left"><div id="queueDel"></div></td>
                                    </tr>
                                    <tr>
                                        <td>เลขผู้เสียภาษี</td><td class="text-left"><div id="taxIdDel"></div></td>
                                    </tr>
                                    <tr>
                                        <td>ชื่อผู้เสนอซื้อ</td><td class="text-left"><div id="bidderNameDel"></div></td>
                                    </tr>
                                    <tr>
                                        <td>ชื่อผู้ยื่น</td><td class="text-left"><div id="agentNameDel"></div></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                            <button type="button" id="confirmDelete" class="btn btn-primary" data-dismiss="modal">ยืนยันการลบ</button>
                        </div>
                    </div>
                </div>
            </div><!-- end delete bidder info form -->
            
            <div id="changeCheckIn" aria-labelledby="bidderLabel" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"><!-- delete bidder info form -->
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">ข้อมูล : การยืนซองเสนอซื้อ</h4>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped table-condensed mb-none">
                                    <tbody>
                                    <tr>
                                        <td>คิวที่</td><td class="text-left"><div id="queueChange"></div></td>
                                    </tr>
                                    <tr>
                                        <td>เลขผู้เสียภาษี</td><td class="text-left"><div id="taxIdChange"></div></td>
                                    </tr>
                                    <tr>
                                        <td>ชื่อผู้เสนอซื้อ</td><td class="text-left"><div id="bidderNameChange"></div></td>
                                    </tr>
                                    <tr>
                                        <td>ยื่นซองเสนอซื้อ</td><td class="text-left"><div id="statusChange"></div></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                            <button type="button" id="confirmChange" class="btn btn-primary" data-dismiss="modal">ยืนยัน</button>
                        </div>
                    </div>
                </div>
            </div><!-- end delete bidder info form -->

        </div><!--  row  -->
    </div><!--  container  -->
</div><!-- main -->
{{>footer}}
<script type="text/javascript">
    var listArr = [];

    $(function(){
        // show bidder info list
        showAllBidder();
        
        
        
        $("#searchQueue").select2();
                
        $.validator.addMethod("time", function (value, element) {
            return this.optional(element) || /^(([0-1]?[0-9])|([2][0-3])):([0-5]?[0-9])(:([0-5]?[0-9]))?$/i.test(value);
        }, "Please enter a valid time.");

        $("#taxId").on("blur",function(){
            if($(this).val().length == 13){
                var dataInfo = {};
                dataInfo["taxId"] = $("#taxId").val();

                var fdata = {};
                fdata["BidderInfo"] = dataInfo;
                var dataJSON = JSON.stringify({bidderInfo: fdata["BidderInfo"]});
                var dataJSONEN = encodeURIComponent(dataJSON);

                searchBidder(dataJSONEN);
            }
            else{
                $("#searching").html('<span class="text-danger">เลขผู้เสียภาษีต้องจำนวน 13 หลักเท่านั้น</span>');
            }
        });
        $("#taxId").focus(function(){
            $("#searching").empty();
        });

        // when you click to show table
        $("button.table").click(function(){
            toggleShow("list");
            
        });
        
        // when you click to cancel
        $("button.cancel").click(function(){
            toggleShow("list");
        });

        // when you click to add bidder info
        $("button.add").click(function(){
            toggleShow("form");

            // when you save form
            $("button.submit").unbind().click(function(){
                var isValid = true;
                $('#form input[required]').each(function() {
                    if($(this).val() == "" && !$(this).prop("disabled"))
                        isValid = false;
                    if($(this).attr("name") == "taxId"){
                        if($(this).val().length != 13){
                            $(this).focus();
                            $("#searching").html('<span class="text-danger">เลขผู้เสียภาษีต้องจำนวน 13 หลักเท่านั้น</span>');
                            isValid = false;
                        }
                    }
                });
                if(isValid){
                    var fdata = dataObject(null);
                    var dataJSON = JSON.stringify({bidderInfo: fdata["BidderInfo"], bidderHistory: fdata["BidderHistory"]});
                    var dataJSONEN = encodeURIComponent(dataJSON);

                    insertBidder(dataJSONEN);
                }
            });
        });

        // when you select remark control
        $("input.remarkControl").click(function(){
            var remarkId = $(this).attr("name").replace("property", "");
            if($(this).val() == "Y"){
                $("#remarkLabel"+remarkId).removeClass("req");
                $("#remark"+remarkId).prop("required", false).val("");
            }
            else{
                $("#remarkLabel"+remarkId).addClass("req");
                $("#remark"+remarkId).prop("required", true).val("");
            }
        });
    });

    function searchBidder(dataJSONEN){
        $("#searching").html("ค้นหาข้อมูล...");

        setTimeout(function(){
            var datas = callAjax("{{_context_path}}/api/auction/bidderInfo/search", "post", dataJSONEN, "json");
            if (typeof datas !== "undefined" && datas !== null) {
                if(datas["lists"].length > 0){
                    $("#searching").html('<span class="text-success"><i class="fa fa-check"></i> พบข้อมูล</span>');

                    var value = datas["lists"][0];

                    $("#bidderName").val(value["bidderName"]);
                    $("#fax").val(value["fax"]);
                    $("#email").val(value["email"]);
                    $("input[name=typeBiz][value=" + getTag(value["typeBiz"], "1") + "]").prop('checked', true);
                }
                else{
                    $("#searching").html('<span class="text-danger"><i class="fa fa-times"></i> ไม่พบข้อมูล</span>');
                }
            }
        }, 100);
    }

    function showAllBidder(){
        listArr = [];
        
        var dataSet = [];    
        var searchQueue = {};
        var datas = callAjax("{{_context_path}}/api/auction/bidderInfo/listsRegister", "post", {}, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            $.each(datas["lists"], function(key, value){
                listArr[value["bidderHistoryId"]] = value;
                dataSet.push(value);
                
                searchQueue[value["queue"]] = value["queue"];
            });
            
            $("#searchQueue").empty();
            $("#searchQueue").append('<option value="" selected="selected">ทั้งหมด</option>');
            $.each(searchQueue, function(key, value){
                $("#searchQueue").append('<option value="'+value+'">'+value+'</option>');
            });      
        }        
        
        var t = $("#table").DataTable( {
            "destroy": true,
            "data": dataSet,
//            "order": [[ 1, 'asc' ]],
            "iDisplayLength": 50,
            "columnDefs": [ 
                { 
                    "targets": 0,
                    "searchable": false,
                    "orderable": false,
                    "data": "bidderHistoryId",
                    "sClass": "text-center col-md-1"
                },
                { 
                    "targets": 1,
                    "data": "queue",
                    "sClass": "text-center col-md-1"
                },
                {
                    "targets": 2,
                    "data": "dateRegister",
                    "sClass": "text-center col-md-1",
                    "render": function (data) {
                        return showTime(data["date"]);
                    }     
                },
                {
                    "targets": 3,
                    "data": "bidderName",
                    "sClass": "col-md-2"
                },
                {
                    "targets": 4,
                    "orderable": false,
                    "data": "property1",
                    "sClass": "text-center",
                    "render": function (data, type, full){
                        var content = '<i class="fa fa-times text-danger"></i>';
                        if(data == 'Y') content = '<i class="fa fa-check text-success"></i>';

                        if(getTag(full["remark1"], "") != "") content += '<br>'+full["remark1"];

                        return content;
                    }     
                },
                {
                    "targets": 5,
                    "orderable": false,
                    "data": "property2",
                    "sClass": "text-center",
                    "render": function (data, type, full){
                        var content = '<i class="fa fa-times text-danger"></i>';
                        if(data == 'Y') content = '<i class="fa fa-check text-success"></i>';

                        if(getTag(full["remark2"], "") != "") content += '<br>'+full["remark2"];

                        return content;
                    }     
                },
                {
                    "targets": 6,
                    "orderable": false,
                    "data": "property3",
                    "sClass": "text-center",
                    "render": function (data, type, full){
                        var content = '<i class="fa fa-times text-danger"></i>';
                        if(data == 'Y') content = '<i class="fa fa-check text-success"></i>';
                        
                        if(getTag(full["remark3"], "") != "") content += '<br>'+full["remark3"];

                        return content;
                    }     
                },
                {
                    "targets": 7,
                    "orderable": false,
                    "data": "property4",
                    "sClass": "text-center",
                    "render": function (data, type, full){
                        var content = '<i class="fa fa-times text-danger"></i>';
                        if(data == 'Y') content = '<i class="fa fa-check text-success"></i>';

                        if(getTag(full["remark4"], "") != "") content += '<br>'+full["remark4"];

                        return content;
                    }     
                },
                {
                    "targets": 8,
                    "orderable": false,
                    "data": "property5",
                    "sClass": "text-center",
                    "render": function (data, type, full){
                        var content = '<i class="fa fa-times text-danger"></i>';
                        if(data == 'Y') content = '<i class="fa fa-check text-success"></i>';

                        if(getTag(full["remark5"], "") != "") content += '<br>'+full["remark5"];

                        return content;
                    }     
                },
                {
                    "targets": 9,
                    "orderable": false,
                    "data": "checkIn",
                    "sClass": "text-center col-md-1",
                    "render": function (data, key, full) {
                        var checked = "";
                        if(data == "Y"){
                            checked = "checked";
                        }
                        
                        var content = '<label class="switch switch-green">'
                            + '<input class="switch-input" type="checkbox" data-hid="'+full["bidderHistoryId"]+'" onclick="return false" '+checked+'>'
                   
                            + '<span class="switch-label" data-on="มา" data-off="ไม่มา"></span>'
                            + '<span class="switch-handle"></span>'
                        + '</label>';
                        
                        return content;
                    }   
                },
                {
                    "targets": 10,
                    "orderable": false,
                    "data": "bidderHistoryId",
                    "sClass": "text-center col-md-1",
                    "render": function (data) {
                        var content = '<button class="btn btn-primary edit" data-hid="'+data+'"><i class="fa fa-pencil"></i></button>&nbsp;'
                            + '<button class="btn btn-default delete" data-hid="'+data+'"><i class="fa fa-trash"></i></button>';
                        return content;
                    }                    
                }
            ]
        });

        t.on( 'order.dt search.dt', function () {
            t.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
                cell.innerHTML = i+1;
            } );
        } ).draw();
        
        $('#searchQueue').change(function() {
            if($('#searchQueue').val() != ""){
                t.columns(1).search("^"+$(this).val()+"$", true, false, true).draw();
            }
            else{
                t.columns(1).search($(this).val()).draw();
            }
        });

        $("#table").off("click", "button.edit").on("click", "button.edit", function(){
            toggleShow("form");

            var historyId = $(this).attr("data-hid");
            var value = listArr[historyId];

            $("#queue").val(value["queue"]);
            $("#dateRegister").val(showTime(value["dateRegister"]["date"]));
            $("#taxId").val(value["taxId"]);
            $("#bidderName").val(value["bidderName"]);
            $("#agentName").val(value["agentName"]);
            $("#agentName2").val(value["agentName2"]);
            $("#mobile").val(value["mobile"]);
            $("#fax").val(value["fax"]);
            $("#email").val(value["email"]);
            $("input[name=typeBiz][value=" + getTag(value["typeBiz"], "1") + "]").prop('checked', true);

            $("input[name=property1][value=" + getTag(value["property1"], "N") + "]").prop('checked', true).trigger("click");
            $("input[name=property2][value=" + getTag(value["property2"], "N") + "]").prop('checked', true).trigger("click");
            $("input[name=property3][value=" + getTag(value["property3"], "N") + "]").prop('checked', true).trigger("click");
            $("input[name=property4][value=" + getTag(value["property4"], "N") + "]").prop('checked', true).trigger("click");
            $("input[name=property5][value=" + getTag(value["property5"], "N") + "]").prop('checked', true).trigger("click");

            $("#remark1").val(value["remark1"]);
            $("#remark2").val(value["remark2"]);
            $("#remark3").val(value["remark3"]);
            $("#remark4").val(value["remark4"]);
            $("#remark5").val(value["remark5"]);

            // when you save the bidder info was modified
            $("button.submit").unbind().click(function(){
                var isValid = true;
                $('#form input[required]').each(function() {
                    if($(this).val() == "" && !$(this).prop("disabled"))
                        isValid = false;
                    if($(this).attr("name") == "taxId"){
                        if($(this).val().length != 13){
                            $(this).focus();
                            $("#searching").html('<span class="text-danger">เลขผู้เสียภาษีต้องจำนวน 13 หลักเท่านั้น</span>');
                            isValid = false;
                        }
                    }
                });
                if(isValid){
                    var fdata = dataObject(historyId);
                    var dataJSON = JSON.stringify({bidderInfo: fdata["BidderInfo"], bidderHistory: fdata["BidderHistory"]});
                    var dataJSONEN = encodeURIComponent(dataJSON);

                    editBidder(dataJSONEN);
                }
            });

        });

        // when you click to delete bidder info
        $("#table").off("click", "button.delete").on("click", "button.delete", function(){
            $('#bidderModal').modal("show");
            
            var historyId = $(this).attr("data-hid");
            var value = listArr[historyId];

            $("#queueDel").html(value["queue"]);
            $("#taxIdDel").html(value["taxId"]);
            $("#bidderNameDel").html(value["bidderName"]);
            $("#agentNameDel").html(value["agentName"]);

            $("#confirmDelete").unbind().click(function(){
                var dataInfo = {};
                var dataHistory = {};

                dataInfo["id"] = value["bidderInfoId"];
                dataHistory["id"] = historyId;

                var fdata = {};
                fdata["BidderInfo"] = dataInfo;
                fdata["BidderHistory"] = dataHistory;

                var dataJSON = JSON.stringify({bidderInfo: fdata["BidderInfo"], bidderHistory: fdata["BidderHistory"]});
                var dataJSONEN = encodeURIComponent(dataJSON);

                deleteBidder(dataJSONEN);
            });

        });
        
        $("#table").off("click", ".switch-input").on("click", ".switch-input", function(){
            $("#changeCheckIn").modal("show");
            
            var check = $(this);
            var hId = $(this).attr("data-hid");
            var value = listArr[hId];
            var checkIn = "";

            //toggle "no check" to "check"
            if($(this).is(':checked')){
                $("#statusChange").html('<span class="text-bold text-success">มา</span>');
                checkIn = "Y";                
            }
            else{
                $("#statusChange").html('<span class="text-bold text-danger">ไม่มา</span>');
                checkIn = "N";
            }

            $("#queueChange").html(value["queue"]);
            $("#taxIdChange").html(value["taxId"]);
            $("#bidderNameChange").html(value["bidderName"]);            
            
            $("#confirmChange").unbind().click(function () {
                var dataHistory = {};
                dataHistory["id"] = hId;
                dataHistory["checkIn"] = checkIn;

                var fdata = {};
                fdata["BidderHistory"] = dataHistory;

                var dataJSON = JSON.stringify({bidderHistory: fdata["BidderHistory"]});
                var dataJSONEN = encodeURIComponent(dataJSON);

                var datas = callAjax("{{_context_path}}/api/auction/bidderInfo/changeCheckIn", "post", dataJSONEN, "json");
                if (typeof datas !== undefined && datas !== null) {
                    if (datas["save"] == true) {
                        
                        if(checkIn == "Y"){
                            check.prop("checked", true);
                        }
                        else{
                            check.prop("checked", false);
                        }
                    }
                }
            });
        });
    }

    function insertBidder(dataJSONEN){
        $("#loading").html("กำลังบันทึกข้อมูล...");

        setTimeout(function(){
            var datas = callAjax("{{_context_path}}/api/auction/bidderInfo/insert", "post", dataJSONEN, "json");
            if (typeof datas !== "undefined" && datas !== null) {
                if(datas["add"] == true){
                    $("#loading").html('<span class="text-success">บันทึกข้อมูลเรียบร้อย</span>');
                    setTimeout(function(){
                        toggleShow("list");
                    }, 500);
                }
                else{
                    $("#loading").html('<span class="text-danger">ไม่สามารถบันทึกข้อมูลได้<br>'+datas["add"]+'</span>');
                }
            }
        }, 100);
    }

    function editBidder(dataJSONEN){
        $("#loading").html("กำลังบันทึกข้อมูล...");

        setTimeout(function(){
            var datas = callAjax("{{_context_path}}/api/auction/bidderInfo/update", "post", dataJSONEN, "json");
            if (typeof datas !== "undefined" && datas !== null) {
                if(datas["update"] == true){
                    $("#loading").html('<span class="text-success">บันทึกข้อมูลเรียบร้อย</span>');
                    setTimeout(function(){
                        toggleShow("list");
                    }, 500);
                }
                else{
                    $("#loading").html('<span class="text-danger">ไม่สามารถบันทึกข้อมูลได้</span>');
                }
            }
        }, 100);
    }

    function deleteBidder(dataJSONEN) {
        var datas = callAjax("{{_context_path}}/api/auction/bidderInfo/delete", "post", dataJSONEN, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            if (datas["delete"] == true) {
                toggleShow("list");
            }
        }
    }

    function dataObject(hid){
        var dataInfo = {};
        var dataHistory = {};

        if(hid !== null){
            $.each(listArr[hid],function(key, value){
                //alert(key+" "+value);
                if(key == "bidderInfoId"){
                    dataInfo["id"] = value;
                }
                else if(key == "bidderHistoryId"){
                    dataHistory["id"] = value;
                }
            });
        }

        $("#form input[type=text], #form input[type=text], #form input[type=radio]:checked").each(function (i) {
            var fattr = $(this).attr("data-entity");
            var fname = $(this).attr("name");
            var fvalue = $(this).val();
            if(fattr == "info"){
                dataInfo[fname] = fvalue;
                //alert(fname+" "+fvalue)
            }
            if(fattr == "history"){
                dataHistory[fname] = fvalue;
                //alert(fname+" "+fvalue)
            }
        });
        var fdata = {};
        fdata["BidderInfo"] = dataInfo;
        fdata["BidderHistory"] = dataHistory;

        return fdata;
    }

    function toggleShow(option){
        if(option == "form"){
            $("#bidderForm, #showTable").show();
            $("#bidderTable, #addToTable").hide();

            $("#form input[type=time], #form input[type=text]").each(function(){
                $(this).val("");
            });
            $("input[name=typeBiz]:radio:first").prop('checked', true).trigger("click");
            $("input[name=property1]:radio:first").prop('checked', true).trigger("click");

            $("#loading, #searching").empty();
        }
        else if(option == "list"){
            $("#bidderTable, #addToTable").show();
            $("#bidderForm, #showTable").hide();
            
            showAllBidder();
            $("#searchQueue").val("").trigger("change");
        }
    }

    function showTime(val){
        var dt = val.split(" ");
        var time = dt[1].split(":");
        var output = time[0]+":"+time[1];
        return output;
    }

    function changeToIcon(val){
        var output;
        
        if(val == "Y") output = '<i class="fa fa-check text-success"></i>';
        else output = '<i class="fa fa-times text-danger"></i>';

        return output;
    }
</script>


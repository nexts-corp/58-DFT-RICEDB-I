{{>header}}
<style>
    .row-tr,.pointer :hover{
        cursor: pointer;
    }
    .datepicker { position: relative; z-index: 10000 !important; }
</style>
<div role="main" class="main">
    <section class="page-top none-margin">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <ul class="breadcrumb">
                        <li><a href="#">{{#i18n}}tracking.home{{/i18n}}</a></li>
                        <li class="active">{{#i18n}}tracking.menu{{/i18n}}</li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h1 class="none-padding">{{#i18n}}tracking.return.title{{/i18n}}</h1>
                </div>
            </div>
        </div>
    </section>

    <hr class="tall dashboard">
    <div class="sort-source-wrapper">
        <div class="container">
            <ul class="nav nav-pills sort-source menu-top pull-right" data-sort-id="portfolio" data-option-key="filter">
                <li data-option-value=".websites" class="padding-left">
                    <button id="showTable" class="btn btn-primary table" style="display: none;"><i class="fa fa-list"></i> {{#i18n}}tracking.buttonInfoList{{/i18n}}</button>
                </li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div class="row">

            <div class='col-md-12'>
                <div id="bidderTable" class="col-md-12" style="margin-top: 10px;">
                    <section class="panel form-wizard" id="w1"><!-- search -->
                        <div class="panel-body panel-body-nopadding">
                            <div class="col-md-12" style="margin: 20px 0px 20px 0px;">
                                <div class="col-sm-8" >
                                    <div class="col-sm-8">
                                        <label class="col-sm-5 control-label text-right">{{#i18n}}tracking.auctionNo{{/i18n}} :</label>
                                        <div class="col-sm-7">
                                            <select id="auction" class="form-control">
                                                <option value="0">เลือกทั้งหมด</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-sm-4">
                                        <button id="btn_date" class="btn btn-primary">{{#i18n}}tracking.buttonShow{{/i18n}}</button>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <label class="col-md-4 control-label text-right" for="searchQueue">{{#i18n}}tracking.queue{{/i18n}} :</label>
                                    <div class="col-md-8">
                                        <select class="form-control input-sm" name="searchQueue" id="searchQueue" required>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section><!-- end search -->

                    <div class="table-responsive col-md-12" style="margin-top: 20px;">
                        <table id="table" class="table table-bordered table-striped table-condensed mb-none">
                            <thead>
                                <tr>
                                    <th class="text-center col-md-2">{{#i18n}}tracking.queue{{/i18n}}</th>
                                    <th class="text-center col-md-7">{{#i18n}}tracking.bidder{{/i18n}}</th>
                                    <th class="text-center col-md-3">{{#i18n}}tracking.action{{/i18n}}</th>
                                </tr>
                            </thead>
                            <tbody id="bidderBody">
                                <tr>
                                    <td colspan="3" class="text-center">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div><!-- col-md-12 -->
                <div id="paymentTable" class="col-md-12" style="display:none;margin-top: 10px;">
                    <div class="col-md-10">
                        <div class="col-md-12 table-responsive">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h2 class="panel-title">{{#i18n}}tracking.return.panelInfo{{/i18n}}</h2>
                                    <div style="float: right; margin-top: -25px;">
                                        <button class="btn btn-primary checkList"><i class="fa fa-print"></i> {{#i18n}}tracking.buttonReturn{{/i18n}}</button>
                                    </div>
                                </div>
                                <div class="panel-body">
                                    <table class="table table-bordered table-striped table-condensed mb-none">
                                        <thead>
                                            <tr>
                                                <th class="text-center col-md-2">{{#i18n}}tracking.queue{{/i18n}}</th>
                                                <th class="text-center col-md-8">{{#i18n}}tracking.bidder{{/i18n}}</th>
                                                <th class="text-center col-md-2">{{#i18n}}tracking.mobile{{/i18n}}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="bdBody">
                                            <tr>
                                                <td colspan="3" class="text-center">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 table-responsive">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <div class="panel-actions">
                                        <a href="#" class="fa fa-caret-up"></a>
                                    </div>
                                    <h2 class="panel-title">{{#i18n}}tracking.return.panelWinner{{/i18n}}</h2>
                                </div>
                                <div class="panel-body">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th class="text-center">{{#i18n}}tracking.no{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.province{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.associate{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.silo{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.bidderLastPrice{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.valuePayment{{/i18n}} (2%)</th>
                                                <th class="text-center">{{#i18n}}tracking.status{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.contract{{/i18n}}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="whBody">
                                            <tr>
                                                <td colspan="8" class="text-center">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 table-responsive">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <div class="panel-actions">
                                        <a href="#" class="fa fa-caret-up"></a>
                                    </div>
                                    <h2 class="panel-title">{{#i18n}}tracking.return.panelHold{{/i18n}} <span class='countAll'>0</span> {{#i18n}}tracking.paymentUnit{{/i18n}}</h2>
                                </div>
                                <div class="panel-body">
                                    <div class="col-md-12">
                                        <div class='col-md-6'>
                                            <p>{{#i18n}}tracking.countChoose{{/i18n}} <span id='countCheckbox'>0</span>/<span class='countAll'>0</span></p>
                                        </div>
                                        <div class="col-md-6 text-right pointer">
                                            <input type="checkbox" name="all" id="checkall" /> <label for="checkall">{{#i18n}}tracking.chooseAll{{/i18n}}</label>
                                        </div>
                                    </div>
                                    <table id="pTable" class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th class="text-center">{{#i18n}}tracking.no{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.typePayment{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.bank{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.bankDate{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.bankNo{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.bankAmount{{/i18n}} ({{#i18n}}tracking.bath{{/i18n}})</th>
                                                <th class="text-center">{{#i18n}}tracking.remark{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.action{{/i18n}}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="paymentBody">
                                            <tr>
                                                <td colspan="8" class="text-center">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="col-md-12 text-center">
                                        <button id="btnSave" class="btn btn-primary"><i class="fa fa-save"></i> {{#i18n}}tracking.buttonSave{{/i18n}}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 table-responsive">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <div class="panel-actions">
                                        <a href="#" class="fa fa-caret-up"></a>
                                    </div>
                                    <h2 class="panel-title">{{#i18n}}tracking.return.panelReturn{{/i18n}} <span id='countReturn'>0</span> {{#i18n}}tracking.paymentUnit{{/i18n}}</h2>
                                </div>
                                <div class="panel-body">
                                    <table  class="table table-bordered table-striped table-condensed mb-none">
                                        <thead>
                                            <tr>
                                                <th class="text-center">{{#i18n}}tracking.no{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.typePayment{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.bank{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.bankDate{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.bankNo{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.bankAmount{{/i18n}} ({{#i18n}}tracking.bath{{/i18n}})</th>
                                                <th class="text-center">{{#i18n}}tracking.remark{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.return.dateReturn{{/i18n}}</th>
                                                <th class="text-center">{{#i18n}}tracking.status{{/i18n}}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="returnBody">
                                            <tr>
                                                <td colspan="8" class="text-center">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <div class="col-md-12">
                            <nav id="affix-nav" class="sidebar">
                                <div class="nav sidenav" data-spy="affix" data-offset-top="0" style="font-size: 130%; min-width: 220px; border: 2px solid #aaa; padding: 9px;">                                    

                                    <div class="text-danger">{{#i18n}}tracking.canReturn{{/i18n}}</div>
                                    <div class="text-danger text-right text-bold"><span id="txtReturn">0</span> {{#i18n}}tracking.bath{{/i18n}}</div><br>

                                    <div class="text-info">{{#i18n}}tracking.siloValueChoose{{/i18n}}</div>
                                    <div class="text-info text-right text-bold"><span id="txtWarehouse">0</span> {{#i18n}}tracking.bath{{/i18n}}</div><br>
                                    <hr>
                                    <div class="text-success">{{#i18n}}tracking.paymentChoose{{/i18n}}</div>
                                    <div class="text-success text-right text-bold"><span id="txtSelect">0</span> {{#i18n}}tracking.bath{{/i18n}}</div><br>

                                    <div class="text-warning">{{#i18n}}tracking.paymentHold{{/i18n}}</div>
                                    <div class="text-warning text-right text-bold"><span id="txtBalance">0</span> {{#i18n}}tracking.bath{{/i18n}}</div>

                                </div>
                            </nav>
                        </div>
                    </div>

                </div><!-- col-md-12 -->
            </div><!-- col-md-9 -->
        </div><!--  row  -->
    </div><!--  container  -->

    <div id="modalFinance" aria-labelledby="finance" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"><!-- delete bidder info form -->
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">{{#i18n}}tracking.return.title{{/i18n}}</h4>
                </div>
                <div class="modal-body">
                    <form id="formFinance" class="form-horizontal">
                        <div class="form-group">
                            <label for="fNo" class="control-label col-sm-4">เลขที่แคชเชียร์เช็ค</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" name="fNo" id="fNo" placeholder="เลขที่แคชเชียร์เช็ค">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fBank" class="control-label col-sm-4">ธนาคาร</label>
                            <div class="col-sm-8">
                                <select id="fBank" name="fBank" class="form-control" disabled>
									<option value="2">กรุงไทย</option>
								</select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fDate" class="control-label col-sm-4">วันที่</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control paymentDate" name="fDate" id="fDate"  />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fAmount" class="control-label col-sm-4">จำนวนเงิน</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" disabled name="fAmount" id="fAmount"  />
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnConfirm" class="btn btn-primary" data-dismiss="modal"><i class="fa fa-save"></i> {{#i18n}}tracking.buttonSave{{/i18n}}</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">{{#i18n}}tracking.buttonCancel{{/i18n}}</button>
                </div>
            </div>
        </div>
    </div><!-- end delete bidder info form -->
</div><!-- main -->
{{>footer}}
<script type="text/javascript">
    var listArr = [];
    var sumNeedGrt = 0;
    var sumPassGrt = 0;
    var sumPayment = 0;
    var sumWareHouse = 0;
    var countCheck = 0;
    var dataPayment;
    var sumReturn = 0;
    var sumReturned = 0;
    var sumFinance = 0;
    $(function () {
        listsAuction();
        $("#btn_date").click(function () {
            var auccode = $('#auction').val();
            listBidder(auccode);
        });
        $("#searchQueue").select2();
        $("button.table").click(function () {
            toggleShow("list");
        });
        $('.paymentDate').datepicker({
            format: "yyyy-mm-dd",
            autoclose: true
        });
        //listsBank();
        $("#btnSave").unbind().click(function () {
            var data = checkSelect();
            if (data == "noCheckbox") {
                $.alert({
                    title: 'คำแนะนำ!',
                    content: 'ไม่ได้เลือกหลักค้ำประกัน!',
                    confirmButton: "ตกลง",
                    theme: 'black',
                    columnClass: 'col-md-4 col-md-offset-4'
                });
            } else {
                $("#modalFinance").modal("show");
                $('#formFinance').find("input[type=text]").val("");
                sumFinance = 0;
                $.each(data, function (k, v) {
                    if (v["paymentId"] != 1) {
                        sumFinance += parseFloat(v["amount"]);
                    }
                });
                $("#fAmount").val(accounting.formatNumber(sumFinance, 2, ",", "."));
                $("#btnConfirm").unbind().click(function () {
                    var fNo = $("#fNo").val();
                    var fBank = $("#fBank").val();
                    var fDate = $("#fDate").val();
                    var nData = data;
                    if (fNo != "" && fDate != "") {
                        $.each(nData, function (k, v) {
                            if (v["paymentId"] != 1) {
                                nData[k]["financeNo"] = fNo;
                                nData[k]["financeBank"] = fBank;
                                nData[k]["financeDate"] = fDate;
                                nData[k]["financeAmount"] = parseFloat(sumFinance);
                            }
                        });
                    }
                    $("#bidderBody").html("<tr><td colspan='3' class='text-center'>กำลังโหลดข้อมูล</td></tr>");
                    setTimeout(function () {
                        var jData = {};
                        jData["bidderPayment"] = nData;
                        var dataJSON = JSON.stringify(jData);
                        var dataJSONEN = encodeURIComponent(dataJSON);
                        var msg = callAjax("{{_context_path}}/api/tracking/return/update", "post", dataJSONEN, "json");
                        if (msg.update === true) {
                            alert("บันทึกเรียบร้อย");
                            var auccode = $('#auction').val();
                            listBidder(auccode);
                            $(".checkList").focus();
                            listPayment(data[0]["bidderHistoryId"]);
                            $('.checkboxWH').each(function (k, v) {
                                $(this).prop("checked", false);
                            });
                            sumWareHouse = 0;
                            $("#txtWarehouse").text(accounting.formatNumber(sumWareHouse, 2, ",", "."));
                        } else {
                            alert("ERROR!!");
                        }
                    }, 1000);
                });
//                var cfm = $.confirm({
//                    title: 'ยืนยันการอนุมัติ!',
//                    content: "คุณต้องการที่จะทำต่อ?",
//                    confirmButton: 'ตกลง',
//                    cancelButton: 'ยกเลิก',
//                    confirmButtonClass: 'btn-success',
//                    cancelButtonClass: 'btn-warning',
//                    theme: 'holodark',
//                    columnClass: 'col-md-4 col-md-offset-4',
//                    autoClose: 'cancel|11000',
//                    confirm: function () {
//                        $("#bidderBody").html("<tr><td colspan='3' class='text-center'>กำลังโหลดข้อมูล</td></tr>");
//                        cfm.close();
//                        setTimeout(function () {
//                            var jData = {};
//                            jData["bidderPayment"] = checkSelect();
//                            var dataJSON = JSON.stringify(jData);
//                            var dataJSONEN = encodeURIComponent(dataJSON);
//                            var msg = callAjax("{{_context_path}}/api/tracking/return/update", "post", dataJSONEN, "json");
//                            if (msg.update === true) {
//                                alert("บันทึกเรียบร้อย");
//                                var auccode = $('#auction').val();
//                                listBidder(auccode);
//                                $(".checkList").focus();
//                                listPayment(data[0]["bidderHistoryId"]);
//                                $('.checkboxWH').each(function (k, v) {
//                                    $(this).prop("checked", false);
//                                });
//                                sumWareHouse = 0;
//                                $("#txtWarehouse").text(accounting.formatNumber(sumWareHouse, 2, ",", "."));
//                                //swap();
//                                //listPayment();
//                            } else {
//                                alert("ERROR!!");
//                            }
//                        }, 1000);
//
//                    }
//                });

            }
        });
    });
    function listsBank() {
        //   if (listsB == "") {
        var listsB = '';
        var datas = callAjax("{{_context_path}}/api/industry/bidderPayment/listsBank", "post", {}, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            $.each(datas["lists"], function (key, value) {
//                if (value["id"] == id) {
//                    listsB += "<option value='" + value["id"] + "' selected>" + value["bankTH"] + "</option>";
//                } else {
                listsB += "<option value='" + value["id"] + "'>" + value["bankTH"] + "</option>";
                // }
            });
        }
        $("#fBank").html(listsB);
    }
    function listsAuction() {
        var datas = callAjax("{{_context_path}}/api/tracking/return/listsAuction", "post", {}, "json");
        var dataAuction = datas["lists"];
        if (dataAuction != null) {
            var html = "";
            $.each(dataAuction, function (key, value) {
                html += "<option value='" + value.keyword + "'>ครั้งที่ " + value.status + "</option>";
                //$(".countAll").text((key + 1));
            });
            $("#auction").html(html);
        }
    }
    function listBidder(auccode) {
        var dataSet = [];
        var searchQueue = {};
        var datas = callAjax("{{_context_path}}/api/tracking/return/listsBidder", "post", {auccode: auccode}, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            $.each(datas["lists"], function (key, value) {
                listArr[value["bidderHistoryId"]] = value;
                dataSet.push(value);
                searchQueue[value["queue"]] = value["queue"];
            });
            $("#searchQueue").empty();
            $("#searchQueue").append('<option value="" selected="selected">ทั้งหมด</option>');
            $.each(searchQueue, function (key, value) {
                $("#searchQueue").append('<option value="' + value + '">' + value + '</option>');
            });
        }

        var t = $("#table").DataTable({
            "destroy": true,
            "data": dataSet,
            "order": [[0, 'asc']],
            "iDisplayLength": 50,
            "columnDefs": [
                {
                    "targets": 0,
                    "data": "queue",
                    "sClass": "text-center col-md-2"
                },
                {
                    "targets": 1,
                    "data": "bidderName",
                    "sClass": "text-left col-md-8"
                },
                {
                    "targets": 2,
                    "orderable": false,
                    "data": "bidderHistoryId",
                    "sClass": "text-center col-md-2",
                    "render": function (data) {
                        var content = '<button class="btn btn-primary return" data-hid="' + data + '"><i class="fa fa-pencil"></i> คืน</button>';
                        return content;
                    }
                }
            ]
        });
        $('#searchQueue').change(function () {
            if ($('#searchQueue').val() != "") {
                t.columns(0).search("^" + $(this).val() + "$", true, false, true).draw();
            }
            else {
                t.columns(0).search($(this).val()).draw();
            }
        });
        $("#table").off("click", "button.return").on("click", "button.return", function () {
            toggleShow("payment");
            var historyId = $(this).attr("data-hid");
            bindBidder(historyId);
            listWarehouse(historyId);
            listPayment(historyId);
        });
    }

    function bindBidder(hId) {
        var value = listArr[hId];
        var html = '';
        html += '<tr>'
                + '<td class="text-center">' + value["queue"] + '</td>'
                + '<td class="text-center">' + value["bidderName"] + '</td>'
                + '<td class="text-center">' + value["mobile"] + '</td>'
                + '</tr>';
        $("#bdBody").html(html);
        $("button.checkList").unbind().click(function () {
            var dataHistory = {};
            var auccode = $('#auction').val();
            dataHistory["queue"] = value["queue"];
            dataHistory["auccode"] = auccode;
            dataHistory["type"] = "industry";
            var fdata = {};
            fdata["report"] = dataHistory;
            var dataJSON = JSON.stringify({report: fdata["report"]});
            var dataJSONEN = encodeURIComponent(dataJSON);
//			alert(dataJSONEN);

            var datas = callAjax("{{_context_path}}/api/report/report/financePayment", "post", dataJSONEN, "json");
            if (typeof datas !== 'undefined' && datas !== null) {
                //alert(datas["export"]);
                var win = window.open(datas["export"], '_blank');
                win.focus();
            }
        });
    }

    function listWarehouse(hId) {
        var auccode = $('#auction').val();
        var datas = callAjax("{{_context_path}}/api/tracking/return/listsWarehouse2", "post", {bidderId: listArr[hId]["bidderId"], auccode: auccode}, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            var html = "";
            var sumBidderPrice = 0;
            var sumWeight = 0;
            var sumGuarantee = 0;
            var sumPassWeight = 0;
            sumPassGrt = 0;
            sumWareHouse = 0;
            var sumPassPrice = 0;
            $.each(datas["lists"], function (key, value) {
                if (value.isSale == 'Y' || value.isSale == 'C' || value.isSale == 'R') {
                    html += '<tr>'
                            + '<td class="text-center">' + (key + 1) + '</td>'
                            + '<td class="text-center">' + value["province"] + '</td>'
                            + '<td class="text-center">' + value["associate"] + '</td>'
                            + '<td class="text-center">' + value["wareHouseCode"] + '</td>'
//                            + '<td class="text-center ">' + accounting.formatNumber(value["oweightAll"], 6, ",", ".") + '</td>'
                            + '<td class="text-center">' + accounting.formatNumber(value["bidderLastPrice"], 2, ",", ".") + '</td>'
                            + '<td class="text-center text-tertiary">' + accounting.formatNumber(value["guarantee"], 2, ",", ".") + '</td>'
                            + "<td class='text-center text-success'>คืนได้</td>"
                            + '<td class="text-center text-bold">'
                            + '<input class="checkboxWH" type="checkbox" value="' + value["guarantee"] + '">'
                            + '</td>'
                            + '</tr>';
                    sumPassWeight += parseFloat(value.oweightAll);
                    sumPassPrice += parseFloat(value.bidderLastPrice);
                    sumPassGrt += parseFloat(value.guarantee);
                } else {
                    html += '<tr>'
                            + '<td class="text-center">' + (key + 1) + '</td>'
                            + '<td class="text-center">' + value["province"] + '</td>'
                            + '<td class="text-center">' + value["associate"] + '</td>'
                            + '<td class="text-center">' + value["wareHouseCode"] + '</td>'
                            // + '<td class="text-center text-tertiary">' + accounting.formatNumber(value["oweightAll"], 6, ",", ".") + '</td>'
                            + '<td class="text-center">' + accounting.formatNumber(value["bidderLastPrice"], 2, ",", ".") + '</td>'
                            + '<td class="text-center text-danger">' + accounting.formatNumber(value["guarantee"], 2, ",", ".") + '</td>'
                            + "<td class='text-center text-danger'>ยังคืนไม่ได้</td>"
                            + '<td></td>'
                            + '</tr>';
                }

                sumBidderPrice += parseFloat(value.bidderLastPrice);
                sumWeight += parseFloat(value.oweightAll);
                sumGuarantee += parseFloat(value.guarantee);
            });
            sumNeedGrt = parseFloat(sumGuarantee) - parseFloat(sumPassGrt);
            html += "<tr>" +
                    "<td colspan='4' class='text-center'>รวมจำนวนหลักค้ำประกัน</td>" +
                    //   "<td class='text-center text-bold'>" + accounting.formatNumber(sumWeight, 6, ",", ".") + "</td>" +
                    "<td class='text-center text-bold'>" + accounting.formatNumber(sumBidderPrice, 2, ",", ".") + "</td>" +
                    "<td class='text-center text-bold text-tertiary'>" + accounting.formatNumber(sumGuarantee, 2, ",", ".") + "</td>" +
                    "<td class='text-center'></td>" +
                    "</tr>" +
                    "<tr>" +
                    "<td colspan='4' class='text-center'>รวมจำนวนหลักค้ำประกันที่สามารถคืนได้</td>" +
                    //  "<td class='text-center text-success text-bold'>" + accounting.formatNumber(sumPassWeight, 6, ",", ".") + "</td>" +
                    "<td class='text-center text-success text-bold'>" + accounting.formatNumber(sumPassPrice, 2, ",", ".") + "</td>" +
                    "<td class='text-center text-success text-bold'>" + accounting.formatNumber(sumPassGrt, 2, ",", ".") + "</td>" +
                    "<td class='text-center'></td>" +
                    "</tr>" +
                    "<tr>" +
                    "<td colspan='4' class='text-center'>รวมจำนวนหลักค้ำประกันที่ไม่สามารถคืนได้</td>" +
                    //   "<td class='text-center text-danger text-bold'>" + accounting.formatNumber((sumWeight - sumPassWeight), 6, ",", ".") + "</td>" +
                    "<td class='text-center text-danger text-bold'>" + accounting.formatNumber((sumBidderPrice - sumPassPrice), 2, ",", ".") + "</td>" +
                    "<td class='text-center text-danger text-bold'>" + accounting.formatNumber(sumNeedGrt, 2, ",", ".") + "</td>" +
                    "<td class='text-center'></td>" +
                    "</tr>";
            $("#whBody").html(html);
            $('.checkboxWH').click(function () {
                if (this.checked) {
                    sumWareHouse += parseFloat(this.value);
                } else {
                    sumWareHouse -= parseFloat(this.value);
                }

                if (parseInt(sumWareHouse) > parseInt(sumPayment - sumNeedGrt)) {
                    alert("จำนวนหลักค้ำประกันไม่พอ");
                    sumWareHouse -= parseFloat(this.value);
                    $(this).prop("checked", false);
                }
                $("#txtWarehouse").text(accounting.formatNumber(sumWareHouse, 2, ",", "."));
            });
        }
    }

    function listPayment(hId) {
        var datas = callAjax("{{_context_path}}/api/tracking/return/listsPayment", "post", {bidderHistoryId: hId}, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            var paymentHTML = "";
            var returnHTML = "";
            var countPayment = 1;
            var countReturn = 1;
            sumPayment = 0;
            sumReturned = 0;
            sumReturn = 0;
            countCheck = 0;
            dataPayment = datas["lists"];
            $.each(datas["lists"], function (key, value) {
                if (value.remark == null || value.remark == "") {
                    value.remark = "-";
                }
                if (value.isReturn == null || value.isReturn == "N") {
                    paymentHTML += '<tr row-index="' + key + '" class="row-tr">'
                            + '<td class="text-center">' + countPayment++ + '</td>'
                            + '<td class="text-center">' + (value.payment) + '</td>'
                            + '<td class="text-center">' + (value.bankTH) + '</td>'
                            + '<td class="text-center">' + (value.paymentDate["date"].substr(0, 10)) + '</td>'
                            + '<td class="text-center">' + (value.paymentNo) + '</td>'
                            + '<td class="text-center">' + accounting.formatNumber(value.amount, 2, ",", ".") + '</td>'
                           // + "<td class='text-center'></td>" +
                            +'<td class="text-center">' + (value.remark) + '</td>'
                            + '<td class="text-center text-bold">'
                            + '<label class="switch switch-green">'
                            + '<input class="switch-input" type="checkbox" onclick="return false" value="' + value.amount + '">'
                            + '<span class="switch-label" data-on="คืน" data-off="ไม่คืน"></span>'
                            + '<span class="switch-handle"></span>'
                            + '</label>'
                            + '</td>'
                            + '</tr>';
                    sumPayment += parseFloat(value.amount);
                } else {
                    returnHTML += '<tr row-index="' + key + '" class="row-tr">'
                            + '<td class="text-center">' + countReturn++ + '</td>'
                            + '<td class="text-center">' + (value.payment) + '</td>'
                            + '<td class="text-center">' + (value.bankTH) + '</td>'
                            + '<td class="text-center">' + (value.paymentDate["date"].substr(0, 10)) + '</td>'
                            + '<td class="text-center">' + (value.paymentNo) + '</td>'
                            + '<td class="text-center">' + accounting.formatNumber(value.amount, 2, ",", ".") + '</td>'
                            + '<td class="text-center">' + (value.remark) + '</td>'
                            + "<td class='text-center'>" + (value.dateReturn["date"].substr(0, 10)) + "</td>"
                            + "<td class='text-center'>" + (value.isReturn == "Y" ? "คืนแล้ว" : "ถูกริบ") + "</td>"
                            + '</tr>';
                    sumReturned += parseFloat(value.amount);
                }


            });
            paymentHTML += '<tr>'
                    + '<td colspan="5" class="text-center">รวมจำนวนหลักค้ำประกันที่ยังไม่คืน</td>'
                    + '<td class="text-center text-bold">' + accounting.formatNumber(sumPayment, 2, ",", ".") + '</td>'
                    + '<td colspan="2"></td>'
                    + '</tr>';
            returnHTML += '<tr>'
                    + '<td colspan="5" class="text-center">รวมจำนวนหลักค้ำประกันที่คืนแล้ว</td>'
                    + '<td class="text-center text-bold">' + accounting.formatNumber(sumReturned, 2, ",", ".") + '</td>'
                    + '<td colspan="3"></td>'
                    + '</tr>';
            $("#paymentBody").html(paymentHTML);
            $("#returnBody").html(returnHTML);
            $("#countReturn").text(--countReturn);
            $(".countAll").text(--countPayment);
            $("#countCheckbox").html(countCheck);
            $("#txtReturn").text(accounting.formatNumber(sumPayment - sumNeedGrt, 2, ",", "."));
            $("#txtSelect").text(accounting.formatNumber(0, 2, ",", "."));
            $("#txtBalance").text(accounting.formatNumber(sumPayment, 2, ",", "."));
            $("input.switch-input").click(function (event) {
                event.stopPropagation();
            });
            $(".row-tr").unbind().click(function (event) {
                var input = $(this).find("td label input.switch-input");
                if (!input.is(":checked"))
                    input.prop("checked", true);
                else
                    input.prop("checked", false);
                if (input.is(":checked")) {
                    countCheck++;
                    sumReturn += parseFloat(input.val());
                } else {
                    countCheck--;
                    sumReturn -= parseFloat(input.val());
                }
                if ((parseInt(sumReturn) > parseInt(sumWareHouse)) && (parseInt(sumReturn) <= parseInt(sumPayment - sumNeedGrt))) {
                    // alert("จำนวนที่เลือกเกินหลักค้ำประกันของคลังที่เลือกไว้");
                    $.alert({
                        title: 'คำแนะนำ!',
                        content: 'จำนวนที่เลือกเกินหลักค้ำประกันของคลังที่เลือกไว้',
                        confirmButton: "ตกลง",
                        theme: 'black',
                        columnClass: 'col-md-4 col-md-offset-4'
                    });
                } else if ((parseInt(sumReturn) > parseInt(sumWareHouse)) && (parseInt(sumReturn) > parseInt(sumPayment - sumNeedGrt))) {
                    alert("จำนวนหลักค้ำประกันไม่พอ!");
                    countCheck--;
                    sumReturn -= parseFloat(input.val());
                    input.prop("checked", false);
                    $("#checkall").prop("checked", false);
                }


                $("#countCheckbox").html(countCheck);
                $("#txtSelect").text(accounting.formatNumber(sumReturn, 2, ",", "."));
                $("#txtBalance").text(accounting.formatNumber(sumPayment - sumReturn, 2, ",", "."));
            });
            //    $("#checkall").prop("checked", false);
            $("#checkall").unbind().click(function () {
                if ($("#checkall").is(":checked")) {
                    $(".switch-input").each(function () {
                        if (!this.checked) {
                            $(this).prop("checked", true);
                            countCheck++;
                            sumReturn += parseFloat(this.value);
                        }
//                        if ((parseInt(sumReturn) > parseInt(sumWareHouse)) && (parseInt(sumReturn) <= parseInt(sumPayment - sumNeedGrt))) {
//                            alert("จำนวนที่เลือกเกินหลักค้ำประกันของคลังที่เลือกไว้");
//                        } else 
                        if ((parseInt(sumReturn) > parseInt(sumWareHouse)) && (parseInt(sumReturn) > parseInt(sumPayment - sumNeedGrt))) {
                            alert("จำนวนหลักค้ำประกันไม่พอ");
                            countCheck--;
                            sumReturn -= parseFloat(this.value);
                            $(this).prop("checked", false);
                            $("#checkall").prop("checked", false);
                            return false;
                        }
                    });
                } else {
                    $(".switch-input").each(function () {
                        if (this.checked) {
                            $(this).prop("checked", false);
                            countCheck--;
                            sumReturn -= parseFloat(this.value);
                        }
                    });
                }
                $("#countCheckbox").html(countCheck);
                $("#txtSelect").text(accounting.formatNumber(sumReturn, 2, ",", "."));
                $("#txtBalance").text(accounting.formatNumber(sumPayment - sumReturn, 2, ",", "."));
            });
        }
    }

    function checkSelect() {
        var i = 0;
        var dataApprove = [];
        var d = new Date();
        var month = d.getMonth() + 1;
        var day = d.getDate();
        var date = d.getFullYear() + '-' + (month < 10 ? '0' : '') + month + '-' + (day < 10 ? '0' : '') + day;
        $('input.switch-input').each(function () {
            if ($(this).is(":checked")) {
                dataPayment[$(this).closest("tr").attr("row-index")]["isReturn"] = "Y";
                dataPayment[$(this).closest("tr").attr("row-index")]["dateReturn"] = date;
                dataApprove[i++] = dataPayment[$(this).closest("tr").attr("row-index")];
            }
//            else {
//                dataPayment[$(this).closest("tr").attr("row-index")]["isReturn"] = "N";
//            }
//            dataApprove[i++] = dataPayment[$(this).closest("tr").attr("row-index")];
        });
        if (dataApprove[0] == null) {
            return "noCheckbox";
        } else {
            return dataApprove;
        }

    }

    function toggleShow(option) {
        if (option == "payment") {
            $("#paymentTable, #showTable").show();
            $("#bidderTable").hide();
        }
        else if (option == "list") {
            $("#paymentTable, #showTable").hide();
            $("#bidderTable").show();
            var auccode = $('#auction').val();
            listBidder(auccode);
        }
    }
</script>